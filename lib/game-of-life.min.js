var GameOfLife=function(b,c){var a=this;this.ALIVE=true;this.DEAD=false;this.target=$(b);c=$.extend({width:10,height:10,speed:10,minNeighbours:2,maxNeighbours:3,respawnNeighbours:3,cellSize:10,canvasPadding:10,cellsMargin:1,backgroundColor:"#333",cellColor:"#555",activeCellColor:"#fff",iteration:null,statusChanged:null},c||{});var d;for(d in c){this[d]=c[d]}this.iterations=0;this.timeout=null;this.grid=new Grid(this.width,this.height,this.DEAD);this.canvas=null;this._fireIteration();this._fireStatusChanged();$(function(){a.canvas=new Canvas(a)})};GameOfLife.prototype.play=function(){this.stop();this._nextStep();this._fireStatusChanged();return this};GameOfLife.prototype._nextStep=function(){var a=this;this.timeout=window.setTimeout(function(){a.update();if(a.isPlaying()){a._nextStep()}},Math.round(1000/this.speed))};GameOfLife.prototype.stop=function(){if(!this.timeout){return}window.clearTimeout(this.timeout);this.timeout=null;this._fireStatusChanged();return this};GameOfLife.prototype.toggle=function(){if(this.isPlaying()){this.stop()}else{this.play()}return this};GameOfLife.prototype.clear=function(){this.iterations=0;return this};GameOfLife.prototype.isPlaying=function(){return this.timeout?true:false};GameOfLife.prototype.getSpeed=function(){return this.speed};GameOfLife.prototype.setSpeed=function(a){this.speed=a;return this};GameOfLife.prototype.update=function(){var b=this,a=new Grid(this.grid);this.grid.each(function(c,g,d){var f=b.grid.countNeighbours(c,g,b.ALIVE);var e=b.DEAD;if(d===b.ALIVE&&f>=b.minNeighbours&&f<=b.maxNeighbours){e=b.ALIVE}else{if(d===b.DEAD&&f===b.respawnNeighbours){e=b.ALIVE}}a.set(c,g,e);b._changeCellInCanvas(c,g,e)});this.grid=a;this.iterations++;this._fireIteration();return this};GameOfLife.prototype.toggleCell=function(a,b){this.changeCell(a,b,this.grid.get(a,b)===this.ALIVE?this.DEAD:this.ALIVE);return this};GameOfLife.prototype.changeCell=function(a,c,b){this._changeCellInMatrix(a,c,b);this._changeCellInCanvas(a,c,b);return this};GameOfLife.prototype._changeCellInMatrix=function(a,c,b){this.grid.set(a,c,b)};GameOfLife.prototype._changeCellInCanvas=function(a,c,b){if(a>=0&&a<=this.width-1&&c>=0&&c<=this.height-1){this.canvas.changeCell(a,c,b===this.ALIVE)}};GameOfLife.prototype._fireIteration=function(){if(this.iteration instanceof Function){this.iteration.call(this,this.iterations)}};GameOfLife.prototype._fireStatusChanged=function(){if(this.statusChanged instanceof Function){this.statusChanged.call(this,this.isPlaying()?"playing":"stopped")}};GameOfLife.prototype.loadSchema=function(e){this.grid=new Grid(this.width,this.height,this.DEAD);this.canvas.clearCells();e=e.split("\n");if(!e.length){return this}var c=e[0].length,d=e.length,b=Math.floor((this.width-c)/2),g=Math.floor((this.height-d)/2),a,f;for(f=0;f<e.length;f++){for(a=0;a<e[f].length;a++){if(parseInt(e[f].charAt(a),10)===1){this.changeCell(a+b,f+g,this.ALIVE)}}}return this};GameOfLife.prototype.remove=function(){this.stop();this.target.empty();return this};var Grid=function(e,b,c){var d=null;if(e instanceof Grid){d=e;e=d.width;b=d.height}this.width=e||0;this.height=b||0;this.matrix=[];if(c===undefined){c=false}if(d===undefined){d=[]}var a,g,f;for(a=-2;a<this.width+2;a++){this.matrix[a]=[];for(g=-2;g<this.height+2;g++){f=c;if(d!==null){f=d.get(a,g)}this.matrix[a][g]=f}}};Grid.prototype.exists=function(a,b){return this.matrix.length-1>=a&&this.matrix[a].length-1>=b};Grid.prototype.get=function(a,b){if(!this.exists(a,b)){return null}return this.matrix[a][b]};Grid.prototype.set=function(a,c,b){if(this.exists(a,c)){this.matrix[a][c]=b}return this};Grid.prototype.each=function(c){var a,b;for(a=-2;a<this.width+2;a++){for(b=-2;b<this.height+2;b++){c.call(this,a,b,this.matrix[a][b])}}return this};Grid.prototype.countNeighbours=function(b,f,c){var d=0;if(c!==undefined&&this.matrix[b][f]===c){d--}var a,e;for(a=b-1;a<=b+1;a++){if(a<-2||a>this.width+2-1){continue}for(e=f-1;e<=f+1;e++){if(e<-2||e>this.height+2-1){continue}if(c===undefined||this.matrix[a][e]===c){d++}}}return d};var Canvas=function(a){this.game=a;this.canvas=null;this.ctx=null;this.canvasWidth=null;this.canvasHeight=null;this._build()};Canvas.prototype._build=function(){var a=this,b=this.game.cellSize+this.game.cellsMargin;this.canvasWidth=((this.game.width*b)-this.game.cellsMargin)+(this.game.canvasPadding*2);this.canvasHeight=((this.game.height*b)-this.game.cellsMargin)+(this.game.canvasPadding*2);this.canvas=document.createElement("canvas");this.canvas.width=this.canvasWidth;this.canvas.height=this.canvasHeight;$(this.canvas).click(function(f){var d=a.game.canvasPadding,c=Math.floor((f.offsetX-d)/b),g=Math.floor((f.offsetY-d)/b);if(c>=0&&c<=a.game.width-1&&g>=0&&g<=a.game.height-1){a.game.toggleCell(c,g)}});this.game.target.html(this.canvas);this.ctx=this.canvas.getContext("2d");this.ctx.fillStyle=this.game.backgroundColor;this.ctx.fillRect(0,0,this.canvasWidth,this.canvasHeight);this.clearCells();return this};Canvas.prototype.clearCells=function(){var a,b;for(a=0;a<this.game.width;a++){for(b=0;b<this.game.height;b++){this.changeCell(a,b,false)}}return this};Canvas.prototype.changeCell=function(a,e,b){var d=(a*(this.game.cellSize+this.game.cellsMargin))+this.game.canvasPadding,c=(e*(this.game.cellSize+this.game.cellsMargin))+this.game.canvasPadding;this.ctx.fillStyle=b?this.game.activeCellColor:this.game.cellColor;this.ctx.fillRect(d,c,this.game.cellSize,this.game.cellSize);return this};